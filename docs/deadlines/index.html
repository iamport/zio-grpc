<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/zio-grpc/blog/rss.xml" title="ZIO gRPC Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zio-grpc/blog/atom.xml" title="ZIO gRPC Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-346180-20","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">ZIO gRPC and Deadlines | ZIO gRPC</title><meta data-react-helmet="true" property="og:image" content="https://scalapb.github.io/zio-grpc/img/zio-grpc-social-light.png"><meta data-react-helmet="true" name="twitter:image" content="https://scalapb.github.io/zio-grpc/img/zio-grpc-social-light.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for ZIO gRPC"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ZIO gRPC and Deadlines | ZIO gRPC"><meta data-react-helmet="true" name="description" content="Setting deadlines with ZIO gRPC"><meta data-react-helmet="true" property="og:description" content="Setting deadlines with ZIO gRPC"><meta data-react-helmet="true" property="og:url" content="https://scalapb.github.io/zio-grpc//zio-grpc/docs/deadlines"><link data-react-helmet="true" rel="shortcut icon" href="/zio-grpc/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://scalapb.github.io/zio-grpc//zio-grpc/docs/deadlines"><link rel="stylesheet" href="/zio-grpc/styles.221113e6.css">
<link rel="preload" href="/zio-grpc/styles.443da1a6.js" as="script">
<link rel="preload" href="/zio-grpc/runtime~main.2c4a2b01.js" as="script">
<link rel="preload" href="/zio-grpc/main.26ebf4b9.js" as="script">
<link rel="preload" href="/zio-grpc/1.a11d6672.js" as="script">
<link rel="preload" href="/zio-grpc/2.dac6a48c.js" as="script">
<link rel="preload" href="/zio-grpc/17.a95edccd.js" as="script">
<link rel="preload" href="/zio-grpc/18.c8845ae8.js" as="script">
<link rel="preload" href="/zio-grpc/935f2afb.bd965fee.js" as="script">
<link rel="preload" href="/zio-grpc/17896441.c723b56f.js" as="script">
<link rel="preload" href="/zio-grpc/c445b332.85f6322a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/zio-grpc/"><img src="/zio-grpc/img/zio-grpc-hero.png" alt="ZIO gRPC" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/zio-grpc/img/zio-grpc-hero.png" alt="ZIO gRPC" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title"> </strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zio-grpc/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/scalapb/zio-grpc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/zio-grpc/"><img src="/zio-grpc/img/zio-grpc-hero.png" alt="ZIO gRPC" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/zio-grpc/img/zio-grpc-hero.png" alt="ZIO gRPC" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title"> </strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/zio-grpc/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/scalapb/zio-grpc" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/quickstart">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/basics">Basics Tutorial</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/installation">Installing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/generated-code">Generated code</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/context">Context and Dependencies</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/decorating">Decorating services</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/zio-grpc/docs/deadlines">ZIO gRPC and Deadlines</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zio-grpc/docs/scala.js">Scala.js</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">ZIO gRPC and Deadlines</h1></header><div class="markdown"><p>When you use a gRPC it is <a href="https://grpc.io/blog/deadlines/" target="_blank" rel="noopener noreferrer">a very important to set deadlines</a>.
In gRPC, deadlines are absolute timestamps that tell our system when the response of an RPC call is
no longer needed. The deadline is sent to the server, and the computation is automatically interrupted
when the deadline is exceeded. The client call automatically ends with a <code>Status.DEADLINE_EXCEEDED</code> error.</p><p>When you don&#x27;t specify a deadline, client requests never timeout. All in-flight requests take
resources on the server, and possibly upstream servers, which can ultimately hurt latency or crash
the entire process.</p><p>In ZIO gRPC you can easily set deadlines (absolute timestamps), or timeouts which are relative to
the time the outbound call is made.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setting-timeout-for-all-requests"></a>Setting timeout for all requests<a class="hash-link" href="#setting-timeout-for-all-requests" title="Direct link to heading">#</a></h2><p>To set the same timeout for all requests, it is possible to provide an effect that produces <code>CallOptions</code>
when constructing the client. This effect is invoked before each request, and can determine the deadline
relative to the system clock at the time the effect is executed.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">import myexample.testservice.ZioTestservice.ServiceNameClient</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import myexample.testservice.{Request, Response}</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import scalapb.zio_grpc.{ZManagedChannel, SafeMetadata}</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import io.grpc.ManagedChannelBuilder</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import io.grpc.CallOptions</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import java.util.concurrent.TimeUnit</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import zio._</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import zio.console._</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">val channel = ZManagedChannel(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ManagedChannelBuilder</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .forAddress(&quot;localhost&quot;, 8980)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .usePlaintext()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// channel: ZManagedChannel[Any] = zio.ZManaged$$anon$2@14409359</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// create layer:</span></div><div class="token-line" style="color:#403f53"><span class="token plain">val clientLayer = ServiceNameClient.live(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  channel,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  options=ZIO.effectTotal(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    CallOptions.DEFAULT.withDeadlineAfter(3000, TimeUnit.MILLISECONDS)),</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  headers=SafeMetadata.make)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// clientLayer: ZLayer[Any, Throwable, Has[ServiceNameClient.ZService[Any, Any]]] = Managed(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">//   self = zio.ZManaged$$anon$2@62a3248c</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// )</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">val myAppLogicNeedsEnv = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  // use layer through accessor methods:</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  res &lt;- ServiceNameClient.unary(Request())</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  _ &lt;- putStrLn(res.toString)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">} yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// myAppLogicNeedsEnv: ZIO[Has[ServiceNameClient.ZService[Any, Any]] with Any with Console, Object, Unit] = zio.ZIO$FlatMap@4d3b22ce</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setting-timeout-for-each-request"></a>Setting timeout for each request<a class="hash-link" href="#setting-timeout-for-each-request" title="Direct link to heading">#</a></h2><p>As in the previous example, assuming there is a client in the environment, we can set the timeout
for each request like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">ServiceNameClient.withTimeoutMillis(3000).unary(Request())</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// res0: ZIO[Has[ServiceNameClient.ZService[Any, Any]] with Any, io.grpc.Status, Response] = zio.ZIO$Read@68dcb25b</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Clients provide (through the <code>CallOptionsMethods</code> trait) a number of methods that make it possible
to specify a deadline or a timeout for each request:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">// Provide a new absolute deadline</span></div><div class="token-line" style="color:#403f53"><span class="token plain">def withDeadline(deadline: Deadline): Service</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// Sets a new timeout for this service</span></div><div class="token-line" style="color:#403f53"><span class="token plain">def withTimeout(duration: zio.duration.Duration): Service</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// Sets a new timeout in millis</span></div><div class="token-line" style="color:#403f53"><span class="token plain">def withTimeoutMillis(millis: Long): Service</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// Replace the call options with the provided call options</span></div><div class="token-line" style="color:#403f53"><span class="token plain">def withCallOptions(callOptions: CallOptions): Service</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// Effectfully update the CallOptions for this service</span></div><div class="token-line" style="color:#403f53"><span class="token plain">def mapCallOptionsM(f: CallOptions =&gt; zio.IO[Status, CallOptions]): Service</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you are using a client instance, the above methods are available to provide you with a new
client that has a modified <code>CallOptions</code> effect. Making the copy of those clients is cheap and can
be safely done for each individual call:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">val clientManaged = ServiceNameClient.managed(channel)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// clientManaged: Managed[Throwable, ServiceNameClient.ZService[Any, Any]] = zio.ZManaged$$anon$2@78963e42</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">val myAppLogic = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  res &lt;- clientManaged.use(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    client =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      client.withTimeoutMillis(3000).unary(Request())</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            .mapError(_.asRuntimeException)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">} yield res</span></div><div class="token-line" style="color:#403f53"><span class="token plain">// myAppLogic: ZIO[Any with Any, Throwable, Response] = zio.ZIO$FlatMap@36ae298</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/scalapb/zio-grpc/edit/master/docs/deadlines.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zio-grpc/docs/decorating"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Decorating services</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zio-grpc/docs/scala.js"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using with Scala.js Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#setting-timeout-for-all-requests" class="table-of-contents__link">Setting timeout for all requests</a></li><li><a href="#setting-timeout-for-each-request" class="table-of-contents__link">Setting timeout for each request</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zio-grpc/docs/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/zio-grpc/docs/installation">Installation</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/scalapb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://gitter.im/ScalaPB/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/scalapb/zio-grpc" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 <a href="https://www.linkedin.com/in/nadav-samet/">Nadav Samet</a></div></div></div></footer></div>
<script src="/zio-grpc/styles.443da1a6.js"></script>
<script src="/zio-grpc/runtime~main.2c4a2b01.js"></script>
<script src="/zio-grpc/main.26ebf4b9.js"></script>
<script src="/zio-grpc/1.a11d6672.js"></script>
<script src="/zio-grpc/2.dac6a48c.js"></script>
<script src="/zio-grpc/17.a95edccd.js"></script>
<script src="/zio-grpc/18.c8845ae8.js"></script>
<script src="/zio-grpc/935f2afb.bd965fee.js"></script>
<script src="/zio-grpc/17896441.c723b56f.js"></script>
<script src="/zio-grpc/c445b332.85f6322a.js"></script>
</body>
</html>